worker_processes auto;

events {
    worker_connections 1024;
}

http {
    resolver 127.0.0.11 valid=30s;

    upstream hived {
        server pixagram:7777;
    }

    upstream hivemind {
        server hivemind:8080;
    }

    init_by_lua_block {
        -- hivemind handles these API namespaces
        hivemind_apis = {
            ["bridge"] = true,
            ["follow_api"] = true,
            ["tags_api"] = true,
        }

        -- specific condenser_api methods handled by hivemind
        hivemind_condenser_methods = {
            ["condenser_api.get_followers"] = true,
            ["condenser_api.get_following"] = true,
            ["condenser_api.get_follow_count"] = true,
            ["condenser_api.get_content"] = true,
            ["condenser_api.get_content_replies"] = true,
            ["condenser_api.get_discussions_by_trending"] = true,
            ["condenser_api.get_discussions_by_hot"] = true,
            ["condenser_api.get_discussions_by_created"] = true,
            ["condenser_api.get_discussions_by_promoted"] = true,
            ["condenser_api.get_discussions_by_blog"] = true,
            ["condenser_api.get_discussions_by_feed"] = true,
            ["condenser_api.get_discussions_by_comments"] = true,
            ["condenser_api.get_replies_by_last_update"] = true,
            ["condenser_api.get_blog"] = true,
            ["condenser_api.get_blog_entries"] = true,
            ["condenser_api.get_active_votes"] = true,
            ["condenser_api.get_reblogged_by"] = true,
            ["condenser_api.get_account_votes"] = true,
        }
    }

    server {
        listen 8080;

        location / {
            set $backend "hived";

            access_by_lua_block {
                ngx.req.read_body()
                local body = ngx.req.get_body_data()
                if not body then
                    return
                end

                -- extract method from JSON-RPC request
                local method = body:match('"method"%s*:%s*"([^"]+)"')
                if not method then
                    return
                end

                -- check full method name first (e.g. condenser_api.get_content)
                if hivemind_condenser_methods[method] then
                    ngx.var.backend = "hivemind"
                    return
                end

                -- check API namespace (e.g. bridge, follow_api)
                local namespace = method:match("^([^%.]+)")
                if namespace and hivemind_apis[namespace] then
                    ngx.var.backend = "hivemind"
                end
            }

            proxy_pass http://$backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Content-Type "application/json";
            proxy_read_timeout 30s;
            proxy_connect_timeout 5s;

            # CORS headers
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type" always;

            if ($request_method = OPTIONS) {
                return 204;
            }
        }

        location /health {
            return 200 '{"status":"ok"}';
            add_header Content-Type application/json;
        }
    }
}
